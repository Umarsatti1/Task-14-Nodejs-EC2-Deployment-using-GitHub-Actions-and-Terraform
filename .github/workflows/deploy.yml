name: Node.js CD to Remote EC2

on:
  push:
    branches: [ main ]

env:
  APP_EC2: "10.0.1.213" # Application EC2 private IP
  SSH_USER: "ubuntu"
  BASE_DIR: "/var/www"
  APP_NAME: "nodeapp"
  APP_PORT: "3000"
  # Derived paths
  APP_CURRENT: "/var/www/nodeapp"
  APP_PREVIOUS: "/var/www/nodeapp_backup"
  APP_NEW: "/var/www/nodeapp_temp"

jobs:
  build-and-test:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build
        run: npm install

      - name: Test
        run: npm test

  deploy:
    needs: build-and-test
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Prepare New Release Directory
      - name: Prepare New Release
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.APP_EC2 }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mkdir -p ${{ env.BASE_DIR }}
            sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.BASE_DIR }}
            rm -rf ${{ env.APP_NEW }}
            mkdir -p ${{ env.APP_NEW }}

      # 2. Copy Artifacts (SCP)
      - name: Copy Artifacts
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.APP_EC2 }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "app.js,package.json,package-lock.json,public/"
          target: ${{ env.APP_NEW }}
          strip_components: 0

      # 3. Activate Release and Restart PM2
      - name: Activate and Start
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.APP_EC2 }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            # Rollback preparation
            rm -rf ${{ env.APP_PREVIOUS }} || true
            [ -d ${{ env.APP_CURRENT }} ] && mv ${{ env.APP_CURRENT }} ${{ env.APP_PREVIOUS }} || true
            mv ${{ env.APP_NEW }} ${{ env.APP_CURRENT }}

            cd ${{ env.APP_CURRENT }}
            npm install --omit=dev
            
            # Smart restart logic
            pm2 restart ${{ env.APP_NAME }} || pm2 start app.js --name ${{ env.APP_NAME }}
            pm2 save

      # 4. Health Check
      - name: Health Check
        run: |
          curl --fail http://${{ env.APP_EC2 }}:${{ env.APP_PORT }}/health

      # 5. Rollback (Only triggers if previous steps fail)
      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.APP_EC2 }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Deployment failed. Rolling back..."
            rm -rf ${{ env.APP_CURRENT }} || true
            mv ${{ env.APP_PREVIOUS }} ${{ env.APP_CURRENT }} || true
            cd ${{ env.APP_CURRENT }} && npm install --omit=dev
            pm2 restart ${{ env.APP_NAME }}